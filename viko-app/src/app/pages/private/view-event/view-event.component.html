<!-- Status bar -->

@if (!event.isViewed) {<div class="text-center font-semibold text-white py-2 rounded-lg bg-gray-400 mx-10"> This event is not visible </div>}

@switch(event.eventStatus){
@case (1) {<div class="text-center font-semibold text-white py-2 rounded-lg bg-green-700 mx-10"> Registrations are open
</div>}
@case (2) {<div class="text-center font-semibold text-white py-2 rounded-lg bg-red-700 mx-10"> Registrations are closed
</div>}
@case (3) {<div class="text-center font-semibold text-white py-2 rounded-lg bg-red-700 mx-10"> This event is finished
</div>}
}

<!-- Main content -->
<main class="flex flex-col lg:flex-row justify-between rounded-lg items-start gap-8 py-8 mt-3 mx-10 bg-white flex-grow">

    <!-- Image -->
    <div class="w-full lg:w-1/4 flex justify-center">
        @if (event.image) {
        <img [src]="event.image" alt="Event Poster" class="rounded-lg shadow-md w-full max-w-[250px]" />
        } @else {
        <img src="https://placehold.co/250x300/cccccc/000000?text=Event+Poster" alt="Event Poster"
            class="rounded-lg shadow-md w-full max-w-[250px]" />
        }
    </div>

    <!-- Event info -->
    <div class="flex-1 space-y-3">
        <h2 class="text-3xl font-bold">{{ event.title }}</h2>

        <div class="flex flex-wrap text-lg gap-10">
            <div>
                <p class="font-semibold text-gray-700">Teacher</p>
                <div class="flex flex-wrap gap-2">
                    <p>{{ event.teacher }}</p>
                    @if(event.teacherPhoto){
                        <img [src]="event.teacherPhoto" class="w-7 h-7 rounded-full object-cover border border-gray-300">
                    }@else {
                        <div
                            class="w-7 h-7 bg-gray-200 rounded-full flex items-center justify-center text-gray-500">
                        </div>
                        
                    }
                </div>
            </div>
            <div>
                <p class="font-semibold text-gray-700">Category</p>
                <p> {{category?.name}} {{category?.emoji}} </p>
            </div>
        </div>

        <div>
            <p class="font-semibold text-gray-700">Languages</p>
            <p> {{event.language}} </p>
        </div>

        <div class="flex flex-wrap gap-10 text-sm text-gray-700">
            <div>
                <p class="font-semibold">Starts at</p>
                <p>{{ event.startDate }}</p>
            </div>
            <div>
                <p class="font-semibold">Finishes at</p>
                <p>{{ event.endDate }}</p>
            </div>
        </div>

        <div class="flex flex-wrap gap-10 text-md text-gray-700">
            <div>
                <p class="font-medium">Location</p>
                <p>{{ event.location }}</p>
            </div>
            <div>
                <p class="font-medium">City</p>
                <p>{{ event.city }}</p>
            </div>
        </div>

        <h3 class="text-lg font-semibold text-gray-800 mt-5">Description</h3>
        <p class="text-gray-700 leading-relaxed text-justify">
            {{ event.description }}
        </p>
    </div>

    <!-- Registration info -->
    <div class="w-full lg:w-1/4 text-center border-t lg:border-t-0 lg:border-l border-gray-200 pt-4 lg:pt-0 lg:pl-6">
        <h4 class="text-lg font-semibold text-gray-800">Registration Deadline</h4>
        <p class="text-gray-700 mb-3">{{ event.registrationDeadline }}</p>

        <!-- <ng-content select="[registration-button]"></ng-content> -->

        @if (roleSaved == "Student") {
            @if (!isRegistered && showRegisterButton && eventStatus == 1) {
                <button registration-button [hidden]="isHidden"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-medium px-6 py-2 rounded-md shadow-sm transition"
                    (click)="registerToEvent()">
                    Sign up to this Event
                </button>
            }

            @if (isRegistered && eventStatus != 3) {
                <p registration-button class="text-green-600 mt-3">
                    You are already registered for this event!
                </p>
                <button cancelRegistration-button [hidden]="isHidden"
                    class="bg-red-600 hover:bg-red-700 text-white font-medium px-6 py-2 mt-3 rounded-md shadow-sm transition"
                    (click)="unregister()">
                    Cancel Registration
                </button>
                
            }
        }

    </div>
</main>

@if (roleSaved == "Teacher" || roleSaved == "Admin") {
    <!-- Overlay + Sidebar Container (mantém sempre no DOM) -->
    <div class="fixed inset-0 z-40 pointer-events-none">

        <!-- Overlay -->
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity duration-300"
            [class.opacity-0]="!editAside" [class.pointer-events-auto]="editAside" (click)="closeEditAside()"></div>

        <!-- Sidebar -->
        <div class="absolute top-0 right-0 h-full w-full sm:w-[450px] bg-white shadow-xl p-6 overflow-y-auto
            transition-transform duration-300 ease-in-out pointer-events-auto" [class.translate-x-full]="!editAside"
            [class.translate-x-0]="editAside">

            <h2 class="text-2xl font-semibold mb-6">Edit Event</h2>

            <form [formGroup]="eventEdit" class="space-y-4">

                <!-- Photo -->
                <div class="relative w-24 h-24">
                    <!-- Foto / Placeholder -->
                    @if (eventEdit.get('image')?.value) {
                    <img [src]="eventEdit.get('image')?.value"
                        class="w-24 h-24 rounded object-cover border border-gray-300" />
                    } @else {
                    <div class="w-24 h-24 bg-gray-200 rounded flex items-center justify-center text-gray-500 text-sm">
                        Photo
                    </div>
                    }

                    <!-- Label / botão de upload -->
                    <label
                        class="absolute bottom-0 right-0 bg-gray-800 text-white text-xs p-1 rounded-full cursor-pointer flex items-center justify-center z-10">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-8 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
                        </svg>

                        <!-- Input escondido -->
                        <input type="file" accept="image/*" (change)="onFileSelected($event)" class="hidden" />
                    </label>
                </div>


                <!-- Title -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" formControlName="title" name="title"
                        class="w-full border border-gray-400 rounded px-3 py-2" />
                </div>

                @if (roleSaved == "Admin") {
                <!-- Teacher -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Teacher</label>
                    <select formControlName="teacher" name="teacher"
                        class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400">
                        @for (teacher of teachers; track teacher.name) {
                        <option [value]="teacher.name">
                            {{teacher.name}} -- user: {{teacher.username}} 
                        </option>
                        }
                    </select>
                </div>
                }

                <!-- Category -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>

                    <select formControlName="category" name="category"
                        class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400">
                        @for (category of categories; track category.name) {
                        <option [value]="category.name">
                            {{ category.name }} {{ category.emoji }}
                        </option>
                        }
                    </select>
                </div>

                <!-- Languages -->
                <div
                    class="relative w-full border border-gray-300 rounded-md px-2 py-2 flex flex-wrap items-center gap-2 focus-within:ring focus-within:ring-blue-200">
                    <label class="block text-sm font-medium text-gray-600">Languages</label>

                    <!-- Tags (línguas selecionadas) -->
                    @for (lang of selectedLanguages; track $index) {
                    <span class="flex items-center gap-1 bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-sm">
                        {{ lang }}
                        <button type="button" class="ml-1 text-blue-500 hover:text-red-500 focus:outline-none"
                            (click)="removeLanguage(lang)">
                            ✕
                        </button>
                    </span>
                    }

                    <input type="text" name="languages" formControlName="language" #inputEl (input)="onSearch()" (focus)="onSearch()"
                        (blur)="onInputBlur()" placeholder="Select your languages"
                        class="w-full border border-gray-300 rounded-md px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200">

                    @if (searching) {
                    <ul
                        class="relative z-10 bg-white border border-gray-300 w-full rounded-md shadow-lg max-h-48 overflow-y-auto">
                        @for (lang of languages; track lang.index){
                        <li (click)="selectLanguage(lang)"
                            class="px-3 py-2 hover:bg-blue-100 cursor-pointer items-center gap-2">
                            <span>{{ lang.name }}</span>
                        </li>
                        }
                    </ul>
                    }
                </div>

                <!-- Dates -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="datetime-local" formControlName="startDate" [min]="minDate" name="startDate"
                            class="w-full border border-gray-400 rounded px-3 py-2" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                        <input type="datetime-local" formControlName="endDate" [min]="minDate" name="endDate"
                            class="w-full border border-gray-400 rounded px-3 py-2" />
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Registration Date</label>
                    <input type="datetime-local" formControlName="registrationDeadline" [min]="minDate" name="registrationDeadline"
                        class="w-full border border-gray-400 rounded px-3 py-2" />
                </div>

                <!-- Location -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                    <input type="text" formControlName="location" name="location"
                        class="w-full border border-gray-400 rounded px-3 py-2" />
                </div>

                <!-- City -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
                    <input type="text" formControlName="city" name="city"
                        class="w-full border border-gray-400 rounded px-3 py-2" />
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea formControlName="description" name="description" rows="4"
                        class="w-full border border-gray-400 rounded px-3 py-2 resize-none"></textarea>
                </div>

                <!-- Buttons -->
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" class="px-4 py-2 border rounded text-gray-700 hover:bg-gray-100"
                        (click)="closeEditAside()">
                        Cancel
                    </button>

                    <button type="button" class="px-5 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 
                            disabled:bg-gray-400 disabled:cursor-not-allowed" (click)="saveEventChanges()"
                        [disabled]="eventEdit.invalid || formUnchanged ">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL DELETE -->
    @if (deletePopup) {
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-white p-6 rounded-lg shadow-lg w-full max-w-md">

            <h2 class="text-xl font-semibold mb-4 text-red-600">
                Delete Event
            </h2>

            <p class="text-gray-700  mb-6">
                Are you sure you want to delete this event? This action is not reversable.
            </p>

            <div class="flex justify-end space-x-3">
                <button (click)="onCancelPopup()"
                    class="flex px-4 py-2 rounded bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold">
                    Cancel
                </button>

                <button (click)="confirmDelete()"
                    class="flex px-4 py-2 gap-2 item-center rounded bg-red-600 hover:bg-red-700 text-white font-semibold">
                    Delete
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-5">
                        <path fill-rule="evenodd"
                            d="M16.5 4.478v.227a48.816 48.816 0 0 1 3.878.512.75.75 0 1 1-.256 1.478l-.209-.035-1.005 13.07a3 3 0 0 1-2.991 2.77H8.084a3 3 0 0 1-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 0 1-.256-1.478A48.567 48.567 0 0 1 7.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 0 1 3.369 0c1.603.051 2.815 1.387 2.815 2.951Zm-6.136-1.452a51.196 51.196 0 0 1 3.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 0 0-6 0v-.113c0-.794.609-1.428 1.364-1.452Zm-.355 5.945a.75.75 0 1 0-1.5.058l.347 9a.75.75 0 1 0 1.499-.058l-.346-9Zm5.48.058a.75.75 0 1 0-1.498-.058l-.347 9a.75.75 0 0 0 1.5.058l.345-9Z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
    }

    <!-- MODAL REPUBLISH -->
    @if (republishPopup) {
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-white p-6 rounded-lg shadow-lg w-full max-w-md">

            <h2 class="text-xl font-semibold mb-4 text-green-600">
                Republish Event
            </h2>

            <p class="text-gray-700  mb-6">
                Are you sure you want to republish this event?
            </p>

            <div class="flex justify-end space-x-3">
                <button (click)="onCancelRepublishPopup()"
                    class="flex px-4 py-2 rounded bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold">
                    Cancel
                </button>

                <button (click)="confirmRepublish()"
                    class="flex px-4 py-2 gap-2 item-center rounded bg-green-600 hover:bg-green-700 text-white font-semibold">
                    Republish
                </button>
            </div>
        </div>
    </div>
    }

    <!-- MODAL ERASE -->
    @if (erasePopup) {
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-white p-6 rounded-lg shadow-lg w-full max-w-md">

            <h2 class="text-xl font-semibold mb-4 text-red-800">
                Erase Event
            </h2>

            <p class="text-gray-700  mb-6">
                Are you sure you want to Erase this event from the <strong>Database</strong>? 
                By confirming this action you are erasing this event from the database.
            </p>

            <div class="flex justify-end space-x-3">
                <button (click)="onCancelErasePopup()"
                    class="flex px-4 py-2 rounded bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold">
                    Cancel
                </button>

                <button (click)="confirmErase()"
                    class="flex px-4 py-2 gap-2 item-center rounded bg-red-800 hover:bg-red-900 text-white font-semibold">
                    Erase from the database
                </button>
            </div>
        </div>
    </div>
    }

    <div class="grid grid-cols-3 gap-6 mt-3 mx-10">
        <div>
            <app-registrations [eventGuid]="eventGuid"></app-registrations>
        </div>
        @if ((roleSaved == "Teacher" && compareNames && event.isViewed) || roleSaved == "Admin") {
            <div>
                <app-actions 
                    [event]="eventEdited" 
                    [eventGuid]="eventGuid"
                    [role]="roleSaved"
                    [eventIsViewed]="eventIsViewed" 
                    (editAside)="onEditAside($event)"
                    (updated)="reloadEvent()" 
                    [eventStatus]="eventStatus" 
                    (deletePopUp)="onDeletePopUp($event)"
                    (republishPopUp)="onRepublishPopUp($event)"
                    (erasePopUp)="onErasePopUp($event)">
                </app-actions>
            </div>
        }
    </div>
}